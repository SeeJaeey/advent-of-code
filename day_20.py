input = """#.#..#..####....##.##..#.#.###..###..######.#..#####.#..###..#.####.#..###.##..#.......##....###...#####....#.##..#.#.#...###..#.####.##.#.###...#.###.##.#..#.#..#....#.#.#...#...#.#....###.#.#.#....###.##..#.##...##.#..##...##########.####....#..##..###.#..###..#.#...########.#.##.##...##....#.#..####.###....#.....#.##.#.##.......#....###......###..#.###.#...######..###..#..#.....##.###..##.###....##..#..#..##..##.#.###.#.#.#...#.#####.....#.##.....#..####.###.#.#.######.###.....##.#...#.###..#####...##...

#.#....###...###.#.######.#..#.####.#..#..#####.#..###.#..##..####....#####..#.#......##..#.##...#..
.#.........#..##.####.##...####.###.##.##.#.##..##........##.##.#....###..###.#.##...#.#.#.##...#.#.
.###...#...#.#...#.##......#..#.#.#####..........#..#.##.#..#.#.##.###.##..........####.#.#.###...#.
##.#.#.#.######.##..####.####.##.#..##..#####..##.#..######.#..##..####.####.##.##....#.#.#.........
####.#.#.######....##.##..#..#...#.##.##.##..#..#.##.##.....##.#....####.###...#...##.##.#..#.#.####
..##..##...#..##.#.##....##..#####.#.#....#.##.###....#.##.##..####..#.#.###.#.#.....##.##.##.......
...#...#.######.#..##.##...#....##.##.###....###.#..#.#.#..##...#.#...#.#.#.....#..##....#..#.##...#
.....#....##..#.##.#.###....#.#..###.#..##..####..#..###..##.#.#.#..###..#.#.#.#..#.###.#.#..##..#..
###...##.##....#..##..##.#.#.##.#...####.##.#.#.#.#.#.#.#.#.#...##.#####.#...###.#..#..#########.#.#
####..##....##.#..#..#.##.####.##...#...##..#####...#.#.#.#..####.#..#..##.....##..##...##.##..###.#
..#.#...####....####.#..#.##...#..##.#####....###.#.##.####.####.######.#.####.###..##.##...#.#.#..#
.#.#.#..###############...##.###########...#.#..#..##.#...##..#.#.#####.###.##..###..#####...#.#.#..
...##...##.######.#..##..#..####......#.###..####.###..##..#.#.#..##...##.#.##.##.#..##.#.##..##..#.
#####..##.##.######...#.##..#....###.###..#.#.###..#.####.###.#...#.#.....##############.#.##.......
.##.#..####..##.#####.#.#...#.....##..#.###.....#..##.##..#.#...##..##...#.#.##...##.......##..#.#.#
#####.##.##...#..#..#.#.##.#...#...#.##.....#.###.#...#..##.##.#...####...#..##..##...#...###.##..#.
#.#####..###..######..##...#..###.#####..#.##.#.#.##..##.#.##..##..#...#.##.##.##.#.#.###..###....#.
#...#....##.###.#...##.#..#..#.#..#..####.#....#...#.##.....#.....#....##.###.##.#.####.#.#...##....
#.#....##..###.#..##....#.......#.#.#####....##..#.#..#..#..#..#..##.#..#.....##.##.#.####..#.##.##.
##...###.#...######..#.#.#.#.##.#.#####..#.#.##.##.#....#.#.###.#.#.#.#...###.....##.........#..#.##
...###..#.##.###..####.###...#.#.##..#.####....##..####.##...#..#.#.#..#..#.##..###.##.#.#...#...#.#
#.####.....#.#..##..###.#...###.##...##..#..##...#.#..###.##..#...##.#...#.#.#..###..##..###.#..#..#
..##.###.#####.####.#.#.....###........#..#.##########..#....#..#....#.#.###.##...##..###..#.#.###..
#.#..#...#.#.#.###.#####..#...#.#....#.####..#..#...#..#...##.##.##.##..#########.#......###....#...
...##..#.#.###..##..##.###.##.#.#...#..##...####.....##..#.##.#.#..####..#..##.#..####.##.####.#..#.
##.#.##.###.#...#.##.#.#.#...##...####.#.....#..#.#.###.#.###....##.#.##...##.#.##..#........#....##
..###.#.#.#.....###.....##...##..#.###..#..##.#......####.####....#.###.#.#.....##..#.##..##....##.#
.#..####.###...####.#...##...#..###.##....#.######..#.###.#...#.#####.#.###..#.......#..#.###..#.#..
#...####..#...#..#...#.#...#.#.#.##.#..###..#..#.#.#.###.#.............##..#.###.#.#...#..#.#...#.#.
..##.###.#.#..###..##......###.#...#.###.########.#......##..##....#.###.##.#.....####.#.#........##
##..#.##.##.###..#.##.####.#..#####.......#..#.#####..##.#####.###....#..#.#..#..#...#.###.##.#..##.
.#..#...#..#.#..###.###.#.....##.###.#....#.##.#.##.#.#..#..##...#...#.###.#..#......###..#.#.##..#.
##..####.##.###.#..#..##..##.###.##.#.###.#...###.##....##.#..##.....#.#....##.#...##..........##.##
##.#...#.#..#.#.##.#.#.#..##.##...#..#####.#..#.#.#.#....#..#..#.######.#..#..#.#######.#....#.....#
.#.....#####.###.###...#.####..#####...##...#..#...#..##...#.##.#..#.#........#.#.#..#.#.#.###..##..
###...#.##..#......#.##.#..###.####.#..##.#..#..#..##..#...#.##.##......###.#.#.#.###........##.###.
.#...##.##..#.#.....##.####.........###.##..##.#......#...#.#..#..##.....#######.##.###...#....##.##
#....#.#...#..#.###..##.....##....####.#####.##.#..#.#...#......#...#....#.##.#.....#..#..#..####..#
###.##.####....#.#.....#..#...#.....###.########....##..##.........##..#..####.#..#..#.#.##...#.##..
.....##.#.####.####..#...##.##.#........####.###....#..####.#.##.#.#.#####..#....##..#......##.#..#.
###.#...###..#..#.###..##.##....###.#.....###.##...#.######.#..#......####.#.#..###.##.###....#...#.
##..#.......#...##.###..###.#####.##....#####.#####...##........####....#...##....#.###..##.#..##..#
..##.##.#.#.#.#.##...##.#.#.####..##...##..###.##.#####.#...#####..#.#.#..#.#.##.##.#....###..#...#.
.#..#.###..##..#.#.##.###...###.######.##....#.....##.#.###.....##.#####..##.####...#.##.#..##..#...
#...##....##.#.#####.####.###..#.....#..#.#.#.###..#####.##.....##.##....#.#.#.#.####..##.###..##...
###....#....#..###..#..#..##.#..###...##...##..###..#.#.##..#.##.#....#..#.##.##..####.#.#####...###
#.#..##...#.#.######..##...#.#.#..##.##.....##.#.#......#..####.....#.#....##.###..####.#..#####.#..
.###.##...##..###...#.#..###..##....###.###..##.#..#.####...#...#####.##.##.##....#....##..#.##...##
..#.#.###.....##...#..##.#...#####.##.###.##..####.###...#.#####.#....##...#...#..####...#..##..##.#
##.#..#..#..###..#.#..##...####.###..###.#....####...#.###.#..##..#..##.##.####.#...#.#.##...#.....#
.#...###.#....##.#..#.......#.#.###..###..##.###..#.#...##..#...#...##...#.#.###.##.#.#.##....#.##.#
.#####...#####...#...#.#.####.#.....####.......#.###.#..#...####.#.#..##...#....###.#.##..#..#..#.##
.#.###.#....#...###.#.#..#..####.#..#..#.#...###.###.####...#...#.#.#.#..##..#..#...##...##.....#..#
...##..#...#.##..#.##.####...####.#.###..###..#####.##..#.####.#.###.#.#.###..#...#..###.....#.##...
.########...##.##.##.....#...#####..####..###..#...#.####..#...###.#..###.#...#..#.#...#.#..#...#...
.##.#####.#..#...###...##.....##.#...####.###.##.#.#...#.#.#.#..#.#...##...#...#.##.####.####.####..
##.###.##..#####...#..####....#.###..####..#..#.#.###...##.##.##..###.#.#.##.#.#.#.##..#.#..#....#..
....##..##...###..#.#.....##...#####.#.#...####..##.######.#...#...#.###.##.#.#.#.###.#.###.#...####
#.####...##.#.#..##.#####.##..##.###...#..#......##...#.#.#.###...#.##...#..#...##.#..###.#...#...##
..#..##.#.##.#.#.##..#####.....#.#.###.#.#.#.###..#####.#.....#.##..####.##.#.#.#.##...###....#.#..#
#.#.#..#.##.#.#.##.#...#....#..##.#.##.#.#.#.####.###.###.#.#.####..#..####.#..#....##..####.....###
##...#..#.####....##..#####.###....#..####.#.####..#.#..#.##.##......#..#####...#.##..####....#.#.##
.#.....##....#...###.######.#..#.###...#.#.#..#...#..##...#####...##..#...#####.#.#.###.###..##....#
.###......###.#..#..#...#.##...#.#...#.#..#..##........#..#.####.#.#..##...##.#....###.##..###.#.#..
..###.....#.#....#..#######.####..###...#...#....#...#..##.#..#.##.##..#.##..###...###.##...##....##
#.##..#####..##.####.#.#.#....#.#.#.#..#.#...####.#..#.#.#.##.##.....#..##...#.##....#..#..#..#.#...
##.##.###.#...#.#.#...#...#..###.###.###...###.#...##....#.###.##........#..###..#.#..###..####.....
##.##.##.###..##...#.#.#.#...#...##.#.##..#.#.####..##..#####....#.#####..#####..#.######.#.#.##.##.
..#...##..##..##...#......#..#..#.#..##...#...#....#.#.#...#.#.#..##.#.#...#...#.#.###....###...#...
...####..#########...#.#.#.##.#.#.#.##.#.##...#.####.#.##.#.####.#......##.#.####.#.##.#..###.#.#..#
#.###.##.###.#.#..###...#.##.######.#.#..#.#####.#.###.#..##..#....###..#.#..#......##.#.###...#.###
##..#.#..###.#.#.#.##.##.##..##..#.#.....##.#.#...#.####.##..##.....##..#.####...###...#.###..##.##.
..#.#...#.#.#.##...#..#....######...#.#.##.###.#..####...#.##.#..#..###........#.....###.#..##..##..
..#.#..#.#....#.#..#....###..###.#...###..####...####.#.#.#..#.....#.###.#.#..#.######.###########..
..#...#..#..##.#.##.#.#.##......####.##.#.###.##..##.#.##.#..#.#.##.#...####.#.#.#..#####.#..######.
##.......#####.....#....#..##.#.##..#.###.#..#######.#.#.#....#.#...##.##..##..##..#....###.#....##.
##...##...##..##.#.#..###.###..###..#######.....####..#.##..######....#..#.#.#.#######..#.####.#####
...#.###..##....##.##..#..#...#####...#..##...#.###...###.##....##..#.##.####..##.#...#.##..##..#.#.
......##.###.#.##..#####.#.##.#.#..##.######.##.#..#.#...#....##.##...#.#####.###.####..#.#.###.#.##
#.#.#..#....#.#..#.#..#.####..#.#.###..###.######..#.####.###..##.#.##...###..##.#######.#..##.###..
#...#...######.#.##.......#..##.#..###..#####.#..##...##.#..#.###.###..##.#..#.###.#..#.#.#..#....##
#######..#.#.###..#...##..#...#..##...####..#.####...##.#..#....####.##.#.#..###.#.##.#..#..#.#.##..
.##.##.##.#..###..####.#..##.....#..###...#.#.###.##..###.#..#.###..###..#.####..#.#....#....####.#.
.#..##.#..##.#.#.##.#.###.#..#..###.#.#..#.#...#####...###.#....#..#.#.#..#.#.##.#..#...##.#.###.#..
#.###..####..###.#.#.##.#.#.#......####.#...#..##.#....#...#.######...#########.#...##.###.#..###.##
##.########....##...###..##.#.#..#.####..#..###.......##..#.####.###...#..###...###......####...#...
.#..########.#.##.#.####..#..##..###.#.##.#..##.##..##.#..##....#...#...###.#.#.#.###.#..#.##.#.###.
##....########..........#.#.###.###..##.##.#....#.#..####.######.#.##.#.#..###...#.##.#.#..##.....##
.####......###..#.##.#.#....##.#...#..##.##.#######.#..###...###..###...#.....###.#.##....##...#.#..
####....#.#..######..#.######..#####..#.##.##..##.#.#.#.....##.###..#.###.##.###.#......##.#..####.#
.#...###..#..#.###...##.#..####..#...#.###.#####..#..#.#..###.#####.##.#..##.#.#.##.....#...###....#
..###..##..#..##..####..##.#.#......#..##.#.##.#.####....##.##.###..##..##.#.##..#####.#.##....#.#.#
.##...##.#.#.###..#.##.#..##..#..#....###....#.##.#...##...#######.###..##...##.##.##.#######....###
##..#.#.###..###...###.##..#.##..#.#.#.###.##...###....#.#..#.#..##.#..##.##....#..#...#....###...#.
#.#..###.##.######.#.#####.#...##..##.....##...##...##..#.###.#...#.#.#..#....##..##.###.##.#.##....
...###.######...##..#.####.###..#...#..#..#..#..##.#.#....#....#####.#.##..#.##.#.########..###.##..
.#...#####.#..#..##.##.#.###......#..#..#.###......#...#.#.#######..#...####.#.########...#..##.#.#.
#..#####.#.#.#....##.#..#.......##..#.##.##......#..##..#..#..##.#.###..#.#.#.#..#..#.##.####.#.#..#
####...#.....#.#..#..#.##########..#..#...######.######.#.#.....#....#.###.####.##..#..#.####..###..
.####.###.####...#...####.##..###..#######.###.#....##.###.#..#.#####...##.#..#.....#.####..#..#####"""

example = """..#.#..#####.#.#.#.###.##.....###.##.#..###.####..#####..#....#..#..##..##
#..######.###...####..#..#####..##..#.#####...##.#.#..#.##..#.#......#.###
.######.###.####...#.##.##..#..#..#####.....#.#....###..#.##......#.....#.
.#..#..##..#...##.######.####.####.#.#...#.......#..#.#.#...####.##.#.....
.#..#...##.#.##..#...##.#.##..###.#......#.#.......#.#.#.####.###.##...#..
...####.#..#..#.##.#....##..#.####....##...##..#...#......#.#.......#.....
..##..####..#...#.#.#...##..#.#..###..#####........#..####......#..#

#..#.
#....
##..#
..#..
..###"""

lines = input.split("\n\n")
enhancement_str = lines[0]
enhancement = []
for char in enhancement_str:
    if char == '#':
        enhancement.append('1')
    elif char == '.':
        enhancement.append('0')

image_str = lines[1]

image_width = len(image_str.splitlines()[0])
image_height = len(image_str.splitlines())

image = [0 for i in range(image_width * image_height)]

for row, row_val in enumerate(image_str.splitlines()):
    for col, char in enumerate(row_val):
        if char == '#':
            image[col + row * image_width] = '1'
        elif char == '.':
            image[col + row * image_width] = '0'

def enhance_image(image, width, height, step):
    outside = '0' if enhancement[0] == '0' else '0' if (step % 2) == 0 else '1'
    new_image = [outside for i in range((width + 2) * (height + 2))]
    new_width = width + 2
    new_height = height + 2

    idx = 0
    for row in range(1, new_height - 1):
        for col in range(1, new_width - 1):
            new_image[col + row * new_width] = image[idx]
            idx += 1

    return new_image, new_width, new_height

def compute_pixel_output(pixel_idx, image, width, step):
    bits = []
    outside = '0' if enhancement[0] == '0' else '0' if (step % 2) == 0 else '1'
    current_idx = pixel_idx - width - 1
    if current_idx >= 0:
        bits.append(image[current_idx])
    else:
        bits.append(outside)
    
    current_idx = pixel_idx - width
    if current_idx >= 0:
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    current_idx = pixel_idx - width + 1
    if current_idx >= 0:
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    current_idx = pixel_idx - 1
    if current_idx >= 0:
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    bits.append(image[pixel_idx])

    current_idx = pixel_idx + 1
    if current_idx < len(image):
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    current_idx = pixel_idx + width - 1
    if current_idx < len(image):
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    current_idx = pixel_idx + width
    if current_idx < len(image):
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    current_idx = pixel_idx + width + 1
    if current_idx < len(image):
        bits.append(image[current_idx])
    else:
        bits.append(outside)

    bits = ''.join(bits)
    enhancement_idx = int(bits, 2)
    #print(bits, enhancement_idx)
    return enhancement[enhancement_idx]

# Apply enhancement algorithm
def enhance(steps, image, image_width, image_height):
    for step in range(steps):
        #print("step:", step)
        image, image_width, image_height = enhance_image(image, image_width, image_height, step)

        update1 = []
        update0 = []
        for pixel in range(len(image)):
            if compute_pixel_output(pixel, image, image_width, step) == '1':
                update1.append(pixel)
            else:
                update0.append(pixel)

        for idx in update1:
            image[idx] = '1'
        
        for idx in update0:
            image[idx] = '0'

    counter = 0
    for c in image:
        if c == '1':
            counter += 1

    return counter

with open('day_20_output.txt', 'w') as f:
    idx = 0
    for j in range(image_height):
        f.write('\n')
        for i in range(image_width):
            f.write('#' if int(image[idx]) else '.')
            idx += 1
        
# Task 1
print("Task 1:", enhance(2, image, image_width, image_height))

# Task 2
print("Task 2:", enhance(50, image, image_width, image_height))




